{% extends "base.html" %}

{% block content %}
<style>
    /* CSS H·ªá th·ªëng Tab & Card */
    .tab-container { display: flex; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid #ddd; }
    .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 1.1em; font-weight: bold; color: #666; transition: 0.3s; }
    .tab-btn.active { color: var(--accent-color); border-bottom: 4px solid var(--accent-color); }
    .tab-content { display: none; }
    .tab-content.active { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    
    .recipe-card { 
        background: white; border-radius: 12px; padding: 20px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; 
        cursor: pointer; border: 1px solid #eee; position: relative; 
        display: flex; flex-direction: column; justify-content: space-between;
        min-height: 200px;
    }
    .recipe-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    
    .match-badge { 
        position: absolute; top: 10px; right: 10px; 
        color: white; padding: 4px 10px; border-radius: 20px; 
        font-size: 0.8em; font-weight: bold; 
    }
    
    .heart-btn { position: absolute; bottom: 15px; right: 15px; font-size: 1.5em; color: #ddd; transition: 0.2s; z-index: 10; cursor: pointer; }
    .heart-btn.active { color: #e74c3c; transform: scale(1.1); }
    
    .recipe-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
    .recipe-modal-content { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 15px; position: relative; max-height: 80vh; overflow-y: auto; }
</style>

<h1 style="margin-bottom: 20px;">üç≥ M√≥n ƒÉn h√¥m nay</h1>

<div class="tab-container">
    <div class="tab-btn active" onclick="switchTab(event, 'browse')">üé® L∆∞·ªõt xem m√≥n</div>
    <div class="tab-btn" onclick="switchTab(event, 'smart')">‚ú® G·ª£i √Ω t·ª´ t·ªß l·∫°nh</div>
</div>

<div id="browse" class="tab-content active">
    {% for recipe in all_recipes %}
    <div class="recipe-card" 
         data-name="{{ recipe.name }}"
         data-ingredients="{{ recipe.ingredients_list }}"
         data-instructions="{{ recipe.instructions }}"
         onclick="openRecipe(this)">
        
        <h3 style="margin-top: 0; padding-right: 30px;">{{ recipe.name }}</h3>
        <p style="color: #666; font-size: 0.9em;">Nguy√™n li·ªáu: {{ recipe.ingredients_list[:60] }}...</p>
        
        <div class="heart-btn {% if recipe.id in fav_ids %}active{% endif %}" 
             data-id="{{ recipe.id }}"
             onclick="toggleHeart(event, this)">
            <i class="fa{% if recipe.id in fav_ids %}s{% else %}r{% endif %} fa-heart"></i>
        </div>
        <span style="color: var(--accent-color); font-weight: bold; margin-top: 10px;">Xem c√¥ng th·ª©c ‚Üí</span>
    </div>
    {% endfor %}
</div>

<div id="smart" class="tab-content">
    {% for item in smart_suggestions %}
    <div class="recipe-card" 
         data-name="{{ item.info.name }}"
         data-ingredients="{{ item.info.ingredients_list }}"
         data-instructions="{{ item.info.instructions }}"
         onclick="openRecipe(this)">
        
        <div class="match-badge" style="background: {% if item.is_urgent %}#e67e22{% else %}#28a745{% endif %};">
            {{ item.score }} ‚≠ê
        </div>

        <h3 style="margin-top: 0; padding-right: 40px;">
            {{ item.info.name }}
            {% if item.is_urgent %}
                <span title="C√≥ nguy√™n li·ªáu s·∫Øp h·∫øt h·∫°n" style="color: #e67e22;"></span>
            {% endif %}
        </h3>

        <div>
            <p style="font-size: 0.85em; color: #28a745; margin: 5px 0;">‚úÖ S·∫µn c√≥: {{ item.matches | join(', ') }}</p>
            
            {% if item.missing %}
                <p style="font-size: 0.85em; color: #dc3545; margin: 5px 0;">‚ùå Thi·∫øu: {{ item.missing | join(', ') }}</p>
            {% endif %}

            {% if item.is_urgent %}
                <p style="font-size: 0.85em; color: #e67e22; font-weight: bold;">‚ö†Ô∏è H√£y d√πng ngay ƒë·ªì s·∫Øp h·∫øt h·∫°n!</p>
            {% endif %}
        </div>

        <div class="heart-btn {% if item.is_fav %}active{% endif %}" 
             data-id="{{ item.info.id }}"
             onclick="toggleHeart(event, this)">
            <i class="fa{% if item.is_fav %}s{% else %}r{% endif %} fa-heart"></i>
        </div>
        <span style="color: var(--accent-color); font-weight: bold; margin-top: 10px;">N·∫•u ngay ‚Üí</span>
    </div>
    {% else %}
    <p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Kh√¥ng c√≥ m√≥n n√†o ph√π h·ª£p (>50%). H√£y th√™m ƒë·ªì v√†o t·ªß nh√©!</p>
    {% endfor %}
</div>

<div id="recipeModal" class="recipe-modal" onclick="closeRecipe()">
    <div class="recipe-modal-content" onclick="event.stopPropagation()">
        <span onclick="closeRecipe()" style="position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer;">&times;</span>
        <h2 id="m-name" style="color: var(--primary-color); margin-top: 0;"></h2>
        <hr>
        <h4>üõí Nguy√™n li·ªáu c·∫ßn c√≥:</h4>
        <p id="m-ingredients" style="line-height: 1.6; background: #f9f9f9; padding: 15px; border-radius: 8px;"></p>
        <h4>üìñ H∆∞·ªõng d·∫´n ch·∫ø bi·∫øn:</h4>
        <p id="m-instructions" style="line-height: 1.6; white-space: pre-line;"></p>
        <button onclick="closeRecipe()" style="margin-top: 20px; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;">ƒê√≥ng th√¥ng tin</button>
    </div>
</div>

<script>
    // 1. Chuy·ªÉn Tab
    function switchTab(e, tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    // 2. M·ªü Modal (S·ª≠ d·ª•ng getAttribute ƒë·ªÉ tr√°nh l·ªói ƒë·ªè VS Code)
    function openRecipe(element) {
        const name = element.getAttribute('data-name');
        const ingredients = element.getAttribute('data-ingredients');
        const instructions = element.getAttribute('data-instructions');

        document.getElementById('m-name').innerText = name;
        document.getElementById('m-ingredients').innerText = ingredients;
        document.getElementById('m-instructions').innerText = instructions;
        document.getElementById('recipeModal').style.display = 'flex';
    }

    function closeRecipe() {
        document.getElementById('recipeModal').style.display = 'none';
    }

    // 3. Th·∫£ tim v√† ƒê·ªìng b·ªô gi·ªØa c√°c Tab
    function toggleHeart(event, element) {
        event.stopPropagation();
        const recipeId = element.getAttribute('data-id');

        fetch(`/toggle_favorite/${recipeId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                // T√¨m t·∫•t c·∫£ tr√°i tim c·ªßa c√πng m·ªôt m√≥n ƒÉn tr√™n trang ƒë·ªÉ ƒë·ªïi m√†u ƒë·ªìng lo·∫°t
                const allSameHearts = document.querySelectorAll(`.heart-btn[data-id="${recipeId}"]`);
                
                allSameHearts.forEach(heart => {
                    const icon = heart.querySelector('i');
                    if (data.status === 'hearted') {
                        heart.classList.add('active');
                        icon.classList.replace('far', 'fas');
                    } else {
                        heart.classList.remove('active');
                        icon.classList.replace('fas', 'far');
                    }
                });
            })
            .catch(err => console.error("L·ªói ƒë·ªìng b·ªô tim:", err));
    }
</script>
{% endblock %}